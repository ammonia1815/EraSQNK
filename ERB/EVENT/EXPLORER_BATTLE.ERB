@ADD_CHARACTER_EXPLORER, ARG
FLAG:8 = 0

SELECTCASE ARG
;빌리져は, たまに처녀
CASE 8
	SIF RAND:10 == 0
		ARG = 9
;ボスを倒しちゃってる場合
CASE 303
	SIF PALAM_EXPLORER("보스격파")
		ARG = 304
CASE 313
	SIF PALAM_EXPLORER("보스격파")
		ARG = 215
CASE 34
	SIF PALAM_EXPLORER("보스격파")
		ARG = 412
CASE 35
	SIF PALAM_EXPLORER("中보스격파")
		ARG = 412
CASE 38
	SIF PALAM_EXPLORER("보스격파")
		ARG = 311
CASE 444
	IF PALAM_EXPLORER("보스격파")
		IF RAND:2
			ARG = 222
		ELSE
			ARG = 316
		ENDIF
	ENDIF
CASE 47
	SIF PALAM_EXPLORER("보스격파")
		ARG = 319
ENDSELECT

;100이상の値なら, 上位種
LOCAL = ARG / 100
ARG %= 100

ADDCHARA ARG

;呼んだキャラをTARGETにする
TARGET = CHARANUM-1
;基本種で無いなら소질とかが変化
IF LOCAL
	CALL HIGH_RANKER, ARG, LOCAL
	SIF CFLAG:8 == 0
		CFLAG:8 = LOCAL
ENDIF

CALL SET_NEWNAME

;스킬라短編だったり長編だったり
IF NO:TARGET == 15
	IF RAND:2
		CFLAG:209 = 2
		EXP:레즈경험 += 20
		ABL:레즈끼 += 1
		TALENT:솔직 = 1
		TALENT:바이 = 1
		TALENT:구지배자의자취 = 1
	ELSE
		CFLAG:209 = 1
		TALENT:아픔에약함 = 1
		TALENT:구지배자의자취 = 1
	ENDIF
ENDIF

;追加技能獲得
CALL RESET_EXP_GAIN, TARGET
CALL GET_EXTALENT, TARGET
CALL GET_EXABL, TARGET

;名前ありキャラは変動無し
SIF COND("유니크") == 0 && RAND:4 == 0
	CALL CHAR_SAMON_T, ARG
;LV
CALL SET_LV_MUMA, TARGET
;ボディ미믹
SIF NO:TARGET == 33
	ABL:ＬＶ = ABL:PLAYER:ＬＶ
;정력セット
CALL SET_COUNTER_BASE
;MAXBASE:정력 = TALENT:상위몽마*5 + ABL:욕망 + ABL:기교*3 + ABL:ＬＶ + PALAM_EXPLORER("敵の強さ")
;BASE:정력 = MAXBASE:정력

FLAG:8 = 1

;상대の人数を설정
CALL SET_PALAM_EXPLORER, "敵キャラ数", 1

@WANDERING_MONSTER
CALL ADD_CHARACTER_EXPLORER, PALAM_EXPLORER("제한エンカウント")

;ARGが0だと全部消去。それ以外の数字だとARG人残す
@DELMONSTER, ARG
IF ARG == 0
	DELCHARA CHARANUM-1
	TARGET = 0
ENDIF
SIF PALAM_EXPLORER("敵キャラ数") == 3 && ARG <= 2
	DELCHARA CHARANUM-1
SIF PALAM_EXPLORER("敵キャラ数") >= 2 && ARG <= 1
	DELCHARA CHARANUM-1


@SEXBATTLE_EXPLORER
#DIM LCOUNT
#DIM MEMO_LINECOUNT
#DIM MEMO_BASE6

;エンカウント回数+1
TFLAG:13 += 1

;戦闘파라미터ーの初期化
VARSET TFLAG, 0, 15, 30
VARSET LOCALS
VARSET LOCAL

;一人目決定
CALL ADD_CHARACTER_EXPLORER, PALAM_EXPLORER("랜덤エンカウント")
LOCALS:1 = %NAME:TARGET%(LV:{ABL:ＬＶ})

;複数登場判定（탐색場所ごと）
SELECTCASE TEXTS("탐색先")
CASE "초원"
	;上位種は単独
	IF RAND:3 == 0 && CFLAG:8 == 0
		CALL WANDERING_MONSTER
		SIF RAND:3 == 0
			CALL WANDERING_MONSTER
	ENDIF
CASE "에르툼삼림"
	;上位種は単独
	IF TALENT:상위몽마 || CFLAG:8 >= 2
	ELSEIF PALAM_EXPLORER("敵の強さ") + PALAM_EXPLORER("ハーレム")*2 > RAND:20
		CALL WANDERING_MONSTER
		SIF PALAM_EXPLORER("敵の強さ") + PALAM_EXPLORER("ハーレム")*2 > RAND:30
			CALL WANDERING_MONSTER
	ENDIF
CASE "류두흐동굴"
	;스투나は멜로나が倒されていないなら멜로나を伴って現れる
	IF NO:TARGET == 34 && PALAM_EXPLORER("中보스격파") == 0 && (CONFIG("탐색ボス") || GETCHARA(35) < 0)
		CALL ADD_CHARACTER_EXPLORER, 35
	;뷔이브, 멜로나, 上位種でないなら複数かも
	ELSEIF NO:TARGET == 34 || NO:TARGET == 35 || (NO:TARGET == 12 && CFLAG:8 == 4)
	ELSEIF PALAM_EXPLORER("敵の強さ") + PALAM_EXPLORER("ハーレム")*2 > RAND:20 && CFLAG:8 == 0
		CALL WANDERING_MONSTER
		SIF PALAM_EXPLORER("敵の強さ") + PALAM_EXPLORER("ハーレム")*2 > RAND:20
			CALL WANDERING_MONSTER
	ENDIF
CASE "안쇼스 해"
	;레비아탄は머메이드２体とともに現れる
	IF NO:TARGET == 13 && CFLAG:8 == 3
		CALL ADD_CHARACTER_EXPLORER, 13
		CALL ADD_CHARACTER_EXPLORER, 13
	ELSEIF PALAM_EXPLORER("敵の強さ") + PALAM_EXPLORER("ハーレム")*2 > RAND:15
		CALL WANDERING_MONSTER
		SIF RAND:5 == 0
			CALL WANDERING_MONSTER
	ENDIF
CASE "베르나도트의대미궁"
	;베르나도트は２匹の알프とともに現れる
	IF NO:TARGET == 47
		CALL ADD_CHARACTER_EXPLORER, 202
		CALL ADD_CHARACTER_EXPLORER, 202
	;미믹以外なら基本的に複数
	ELSEIF NO:TARGET == 33
	ELSE
		CALL WANDERING_MONSTER
		SIF PALAM_EXPLORER("敵の強さ") + PALAM_EXPLORER("ハーレム")*2 > RAND:20
			CALL WANDERING_MONSTER
	ENDIF
CASE "고즈번 사막"
	;에스프라나は妹二人とともに現れる
	IF NO:TARGET == 38
		SIF CONFIG("탐색ボス") || GETCHARA(39) < 0
			CALL ADD_CHARACTER_EXPLORER, 39
		SIF CONFIG("탐색ボス") || GETCHARA(40) < 0
			CALL ADD_CHARACTER_EXPLORER, 40
	ELSE
		CALL WANDERING_MONSTER
		SIF RAND:5 == 0
			CALL WANDERING_MONSTER
	ENDIF
CASE "키아즈마의유곽"
	;린は타마모と하츠메を伴う
	IF NO:TARGET == 44
		SIF RAND:2
			CALL ADD_CHARACTER_EXPLORER, 222
		SIF RAND:2
			CALL ADD_CHARACTER_EXPLORER, 316
	;하츠메
	ELSEIF NO:TARGET == 22 && CFLAG:8 == 2 && RAND:3 == 0
	;린以外は複数率高い
	ELSE
		SIF RAND:3 || ABL:ＬＶ < ABL:PLAYER:ＬＶ
			CALL WANDERING_MONSTER
		SIF PALAM_EXPLORER("敵の強さ") + PALAM_EXPLORER("ハーレム")*2 > RAND:20
			CALL WANDERING_MONSTER
	ENDIF
ENDSELECT

;この時点で, PALAM_EXPLORER("敵キャラ数")に상대の人数が記録され, TARGETは最後に呼ばれたキャラとなっている
;かつ, PALAM_EXPLORER("一人目or二人目or三人目")に, それぞれのキャラ登録番号が代入されている
;LOCALS:1～3はそれぞれの名前. 
SIF PALAM_EXPLORER("敵キャラ数") == 3
	LOCALS:3 = %NAME:PALAM_EXPLORER("三人目")%(LV:{ABL:PALAM_EXPLORER("三人目"):90})
SIF PALAM_EXPLORER("敵キャラ数") >= 2
	LOCALS:2 = %NAME:PALAM_EXPLORER("二人目")%(LV:{ABL:PALAM_EXPLORER("二人目"):90})

SETCOLOR DEF_COLOR("노랑")

;全員の名前一緒
IF LOCALS:1 == LOCALS:2 && LOCALS:1 == LOCALS:3
	PRINTFORM %LOCALS:1%×３
;二人の名前が一緒
ELSEIF LOCALS:1 == LOCALS:2
	PRINTFORM \@ PALAM_EXPLORER("敵キャラ数") == 3 ? %LOCALS:3%%조사만처리(NAME:PALAM_EXPLORER("三人目"),"과")%  # \@%LOCALS:1%×２
ELSEIF LOCALS:1 == LOCALS:3
	PRINTFORM %LOCALS:2%%조사만처리(NAME:PALAM_EXPLORER("二人目"),"과")% %LOCALS:1%×２
ELSEIF PALAM_EXPLORER("敵キャラ数") >= 2 && LOCALS:2 == LOCALS:3
	PRINTFORM %LOCALS:2%×２%조사만처리(NAME:PALAM_EXPLORER("二人目"),"과")% %LOCALS:1%
;全員別
ELSE
	SIF PALAM_EXPLORER("敵キャラ数") >= 3
		PRINTFORM %LOCALS:3%%조사만처리(NAME:PALAM_EXPLORER("三人目"),"과")% 
	SIF PALAM_EXPLORER("敵キャラ数") >= 2
		PRINTFORM %LOCALS:2%%조사만처리(NAME:PALAM_EXPLORER("二人目"),"과")% 
	PRINTFORM %LOCALS:1%
ENDIF
PRINTFORMW %조사만처리(NAME:PALAM_EXPLORER("一人目"),"가")% 나타났다! 

RESETCOLOR

;遭遇구상を喋るのは一人目が代表
TRYCALL KOJO_MESSAGE_SEXBATTLE_A, NO:PALAM_EXPLORER("一人目")

;하츠메の분신の術
IF NO:TARGET == 22 && CFLAG:8 == 2 && PALAM_EXPLORER("敵キャラ数") == 1
	PRINTFORML %조사처리(CALLNAME:TARGET,"는")% 분신술을 사용했다! 
	CALL ADD_CHARACTER_EXPLORER, 222
	CALL ADD_CHARACTER_EXPLORER, 222
	LOCALS:2 = %NAME:PALAM_EXPLORER("二人目")%(LV:{ABL:PALAM_EXPLORER("二人目"):90})
	LOCALS:3 = %NAME:PALAM_EXPLORER("三人目")%(LV:{ABL:PALAM_EXPLORER("三人目"):90})
	PRINTFORML %조사처리(CALLNAME:TARGET,"는")% 세 명으로 덤벼들었다! 
ENDIF

;무드 0,1～4,5～8,9이상でランク分け. 
CALL SET_PALAM_EXPLORER, "무드", TALENT:PLAYER:매혹+TALENT:PLAYER:수수께끼의매력+TALENT:PLAYER:매력

;戦闘ターン初期化
TFLAG:12 = 0
$START_BATTLE
TFLAG:12 += 1

;플레이ヤーが攻撃선택
CALL SELECTCOM_SEXBATTLE_EXPLORER

;상대がイってない
IF BASE:정력 > 0
	;상대の反撃
	CALL COUNTER_SEXBATTLE_EXPLORER

	;イかされてしまったなら, 스톡の判定
	SIF BASE:PLAYER:정력 <= 0
		CALL TEXT_LOSE_EXPLORER

	;勝負がついていないなら続行
	SIF BASE:PLAYER:정력 > 0
		GOTO START_BATTLE

	;敗北確定
	CALL DELMONSTER
	RETURN 0
;상대をイかせた
ELSEIF BASE:정력 <= 0
	CALL TEXT_WIN_EXPLORER
	;勝負がついていないなら続行
	SIF BASE:정력 > 0
		GOTO START_BATTLE
ENDIF

;PRINTFORML "戦闘턴수" = {PALAM_EXPLORER("戦闘턴수")}
;戦闘ターン数に応じて시간制限が迫る
COUNT:99 += PALAM_EXPLORER("戦闘턴수")/5

;경험치算出
LOCAL = (MAX(1, ABL:ＬＶ - ABL:PLAYER:ＬＶ) + ABL:ＬＶ/4 + TALENT:상위몽마*5) * PALAM_EXPLORER("敵キャラ数")

;경험치Get
EXP:PLAYER:경험치 += MULTIPLY(LOCAL, 100 + TALENT:MASTER:습득경험치율)
;조수にもおこぼれ
IF PLAYER == MASTER && ASSI
	EXP:ASSI:조수경험 += MAX(LOCAL/2, 1)
	EXP:ASSI:경험치 += MAX(LOCAL/2, 1)
ENDIF
;PRINTFORM {LOCAL}Ｐの경험치を得た. 

;IF PALAM_EXPLORER("무드") > 10 && RAND:100 == 0
;	PRINTFORM %CALLNAME:TARGET%의 팬티獲得. 
IF PALAM_EXPLORER("무드") > 10 && RAND:20 == 0 && ITEM:문드롭스 + I:99 < 99
	PRINTFORM %조사처리(CALLNAME:TARGET,"는")% 
	CALL PRINT_COLORTEXT, "문드롭스", DEF_COLOR("황색")
	PRINTFORM 를 떨어뜨렸다. 
	IF PLAYER != MASTER && COND("몽마", PLAYER)
		PRINTFORM %조사처리(CALLNAME:PLAYER,"는")% 만족했다. 
		CFLAG:PLAYER:2 += 50
		BASE:PLAYER:정력 = MAXBASE:PLAYER:정력
	ELSE
		I:99 += 1
	ENDIF
	PRINTL 
ELSEIF PALAM_EXPLORER("무드") > RAND:20
	PRINTFORM %조사처리(CALLNAME:TARGET,"는")% 보물상자를 떨어뜨렸다. 
	CALL SET_PALAM_EXPLORER, "財宝期待値", PALAM_EXPLORER("무드") * (4 + RAND:7)
	;보너스
	CALL SET_PALAM_EXPLORER, "아이템레벨", 1
	CALL TREASURE_BOX_EXPLORER_B, TARGET
	CALL SET_PALAM_EXPLORER, "아이템레벨", -1
ELSE
	IF PALAM_EXPLORER("敵キャラ数") > RAND:3
		IF ITEM:음마의물방울 + I:78 < 999 && COND("몽마") && RAND:5
			PRINTFORM %조사처리(CALLNAME:PLAYER,"는")% 
			CALL PRINT_COLORTEXT, "음마의물방울", DEF_COLOR("황색")
			PRINTFORM 을 손에 넣었다. 
			I:78 += 1
		ENDIF
	ENDIF
	SELECTCASE TEXTS("탐색先")
	CASE "키아즈마의유곽"
	CASEELSE
		MONEY:5 = (PALAM_EXPLORER("敵の強さ") + ABL:ＬＶ) * (5 + RAND:5) * PALAM_EXPLORER("敵キャラ数")
		CALL PRINT_COLORTEXT, MONEY_C(MONEY:5), DEF_COLOR("황색")
		PRINTFORML 획득.
		MONEY:6 += MONEY:5
	ENDSELECT
ENDIF

;보스격파플래그
SELECTCASE NO:TARGET
CASE 3
	IF CFLAG:8 == 3
		CALL SET_PALAM_EXPLORER, "에르툼삼림：보스격파"
		CALL SET_PALAM_EXPLORER, "보스격파"
	ENDIF
CASE 13
	IF CFLAG:8 == 3
		CALL SET_PALAM_EXPLORER, "안쇼스 해：보스격파"
		CALL SET_PALAM_EXPLORER, "보스격파"
	ENDIF
CASE 34
	CALL SET_PALAM_EXPLORER, "류두흐동굴：보스격파"
	CALL SET_PALAM_EXPLORER, "보스격파"
	IF PALAM_EXPLORER("敵キャラ数") >= 2 && NO:PALAM_EXPLORER("二人目") == 35
		CALL SET_PALAM_EXPLORER, "류두흐동굴：中보스격파"
		CALL SET_PALAM_EXPLORER, "中보스격파"
	ENDIF
CASE 35
	CALL SET_PALAM_EXPLORER, "류두흐동굴：中보스격파"
	CALL SET_PALAM_EXPLORER, "中보스격파"
CASE 38
	CALL SET_PALAM_EXPLORER, "고즈번 사막：보스격파"
	CALL SET_PALAM_EXPLORER, "보스격파"
CASE 44
	CALL SET_PALAM_EXPLORER, "키아즈마의유곽：보스격파"
	CALL SET_PALAM_EXPLORER, "보스격파"
CASE 47
	CALL SET_PALAM_EXPLORER, "베르나도트의대미궁：보스격파"
	CALL SET_PALAM_EXPLORER, "보스격파"
ENDSELECT

;仲魔判定(名前ありのボスはいつでも仲魔に入りたがる)
SELECTCASE TEXTS("탐색先")
CASE "키아즈마의유곽"
CASEELSE
	IF FLAG:246 == 3 || NO:TARGET == 34 || NO:TARGET == 35 || NO:TARGET == 38 || TALENT:첫사람
		LOCAL = 3
		;무드が高い
		SIF PALAM_EXPLORER("무드") > 10
			LOCAL += PALAM_EXPLORER("무드") - 9
		;수수께끼의매력
		SIF TALENT:PLAYER:수수께끼의매력
			LOCAL += 1
		;첫사람
		SIF TALENT:첫사람
			LOCAL = 10

		;ボス
		SELECTCASE NO:TARGET
		CASE 34
			;스투나が仲間に居る？
			IF FIND_COND("Ｃ스투나")
				LOCAL = 0
			ELSE
				LOCAL = 10
			ENDIF
		CASE 35
			;멜로나が仲間に居る？
			IF FIND_COND("Ｃ멜로나")
				LOCAL = 0
			ELSE
				LOCAL = 10
			ENDIF
		CASE 38
			;에스프라나が仲間に居る？
			IF FIND_COND("Ｃ에스프라나")
				LOCAL = 0
			ELSE
				LOCAL = 10
			ENDIF
		ENDSELECT

		;仲魔になる
		IF LOCAL > RAND:10
			PRINTL 
			LASTWORD = %CALLNAME:TARGET%
			;ストメロ限定
			IF NO:TARGET == 34 && PALAM_EXPLORER("敵キャラ数") >= 2 && NO:PALAM_EXPLORER("二人目") == 35
				PRINTFORML %LASTWORD와()% 멜로나는 일어나, 동료마가 된 듯이 %조사처리(CALLNAME:PLAYER,"를")% 보고 있다…
			;하피姉妹
			ELSEIF NO:TARGET == 38 && PALAM_EXPLORER("敵キャラ数") >= 2
				PRINTFORML %LASTWORD와()% 여동생은 일어나, 동료마가 된 듯이 %조사처리(CALLNAME:PLAYER,"를")% 보고 있다…
			;강기かツンデレ（스투나と리저드맨）限定
			ELSEIF NO:TARGET == 12 || NO:TARGET == 34
				PRINTFORM %LASTWORD는()%  
				IF RAND:3 == 0
					PRINTFORM 억울해하는 듯하면서도, 
				ELSEIF RAND:2 == 0
					PRINTFORM 저주의 말을 퍼부으면서도, 
				ELSE
					PRINTFORM 숨을 거칠게 쉬면서, 
				ENDIF
				PRINTFORM %CALLNAME:PLAYER%
				IF RAND:3 == 0
					PRINTFORML %조사만처리(CALLNAME:PLAYER,"를")% 어딘가 기대하는 눈동자로 계속 노려보고 있다…
				ELSEIF RAND:2 == 0
					PRINTFORML %조사만처리(CALLNAME:PLAYER,"를")% 힐끔힐끔 쳐다보면서 얼굴을 붉히고 있다…
				ELSE
					PRINTFORML %조사만처리(CALLNAME:PLAYER,"를")% 유혹하는 듯이 도발하고 있다…
				ENDIF
			;その他범용
			ELSE
				PRINTFORM %LASTWORD는()% 
				IF RAND:4 == 0
					PRINTFORM 가로누워 얼굴만을 이쪽으로 향한 채, 
				ELSEIF RAND:3 == 0
					PRINTFORM 부들부들 쾌감에 몸을 떨면서, 
				ELSEIF RAND:2 == 0
					PRINTFORM 불붙은 신체를 만지작거리면서, 
				ELSE
					PRINTFORM 천천히 몸을 일으켜, 
				ENDIF
				PRINTFORM %CALLNAME:PLAYER%
				IF RAND:5 == 0
					PRINTFORML 의 이름을 계속 부르고있다…
				ELSEIF RAND:4 == 0
					PRINTFORML 에게 뜨거운 시선을 보내고있다…
				ELSEIF RAND:3 == 0
					PRINTFORML 의 발치에 가까이 다가온다…
				ELSEIF RAND:2 == 0
					PRINTFORML 에게 손을 뻗어 따라 왔다…
				ELSE
					PRINTFORML 에게 더욱 더 행위를 요구하고 있다…
				ENDIF
			ENDIF

			PRINTFORML [0] 손을 잡는다 [1] 돌아보지 않는다
			CALL INPUT_SELECT, 2

			IF RESULT == 0
				TRYCALL KOJO_MESSAGE_SEXBATTLE_C, NO:TARGET
				LASTWORD = %CALLNAME:TARGET%
				;再소환不可플래그(TARGETがボス以外なら SETFLAG, "아이템플래그調整" で元に戻る)
				FLAG:(NO:TARGET + 999) = 0
				;조교の初回は表示しない
				CFLAG:201 = 1
				;호감도보너스
				CFLAG:2 = 100
				IF NO:TARGET == 34 && PALAM_EXPLORER("敵キャラ数") >= 2 && NO:PALAM_EXPLORER("二人目") == 35
					LASTWORD = %조사처리(CALLNAME:TARGET,"과")% 멜로나
					FLAG:1034 = 0
					CFLAG:PALAM_EXPLORER("二人目"):201 = 1
					;호감도보너스
					CFLAG:PALAM_EXPLORER("二人目"):2 = 100
					CALL DELMONSTER, 2
				ELSEIF NO:TARGET == 38 && PALAM_EXPLORER("敵キャラ数") >= 2
					IF PALAM_EXPLORER("敵キャラ数") >= 3
						LASTWORD = %LASTWORD와()% 여동생들
						CFLAG:PALAM_EXPLORER("二人目"):201 = 1
						CFLAG:PALAM_EXPLORER("二人目"):2 = 100
						CFLAG:PALAM_EXPLORER("三人目"):201 = 1
						CFLAG:PALAM_EXPLORER("三人目"):2 = 100
					ELSEIF NO:PALAM_EXPLORER("二人目") == 39
						LASTWORD = %LASTWORD와()% 리즈・라즈
						FLAG:1038 = 0
						CFLAG:PALAM_EXPLORER("二人目"):201 = 1
						CFLAG:PALAM_EXPLORER("二人目"):2 = 100
					ELSEIF NO:PALAM_EXPLORER("二人目") == 40
						LASTWORD = %LASTWORD와()% 롯코・바롯코
						FLAG:1039 = 0
						CFLAG:PALAM_EXPLORER("二人目"):201 = 1
						CFLAG:PALAM_EXPLORER("二人目"):2 = 100
					ENDIF
				ELSE
					CALL DELMONSTER, 1
				ENDIF
				PRINTFORML %LASTWORD를()% 데리고 돌아갑니다
				I:999 = 1
				COUNT:99 = 29
				RETURN 0
			ENDIF
		ENDIF
	ENDIF
ENDSELECT

PRINTL 
;정력とLINECOUNTを記録
MEMO_BASE6 = BASE:PLAYER:정력
MEMO_LINECOUNT = LINECOUNT

;エンカウント回数が3+4nでセリフを出してみる
SIF PLAYER == MASTER && ASSI && (PALAM_EXPLORER("エンカウント回数") + 1)%4 == 0
	TRYCALLFORM GUEST_KOJO_K{NO:ASSI}_{CFLAG:ASSI:209}, "탐색：ご休憩", ASSI

;セリフが無いor정력の変動がなければ범용地の文出力
IF LINECOUNT == MEMO_LINECOUNT
	CLEARLINE 1
	CALL HEAL_EXPLORER, "잠시 쉬어"
ELSEIF MEMO_BASE6 == BASE:PLAYER:정력
	PRINTL 
	CALL HEAL_EXPLORER, "잠시 쉬어"
ENDIF

PRINTFORML 탐색속행.
CALL DELMONSTER

WAIT

@HEAL_EXPLORER, ARGS, ARGS:1
PRINTFORM %ARGS% 정력 회복 {BASE:PLAYER:정력}→

;정력が33%회복. 食事を追加してるなら, その分も加味. 
BASE:PLAYER:정력 = MIN(BASE:PLAYER:정력 + MAXBASE:PLAYER:정력/3 + PALAM_EXPLORER("정력회복보정"), MAXBASE:PLAYER:정력)

PRINTFORM {BASE:PLAYER:정력}/{MAXBASE:PLAYER:정력}%ARGS:1%.


@TEXT_LOSE_EXPLORER
SETCOLOR DEF_COLOR("노랑")

PRINTFORM %조사처리(CALLNAME:PLAYER,"는")% 
IF PALAM_EXPLORER("Ｖ인서트")
	PRINTFORML %CALLNAME:TARGET%의 질내에 대량으로 사정하고 말았다！
	CALL SETFLAG, "질내정액경험", 1
ELSEIF PALAM_EXPLORER("Ａ인서트")
	PRINTFORML %CALLNAME:TARGET%의 애널에 대량으로 사정하고 말았다！
	CALL SETFLAG, "장내정액경험", 1
ELSEIF PALAM_EXPLORER("에이스오브스페이드")
	PRINTFORML %CALLNAME:TARGET%의 보지에 자신의 보지를 문지르다가, 가버리고 말았다！
ELSEIF PALAM_EXPLORER("키스") || PALAM_EXPLORER("펠라치오")
	PRINTFORML %CALLNAME:TARGET%의 교묘한 혀놀림에 가버리고 말았다！
	CALL SETFLAG, "정음경험", 1
ELSEIF PALAM_EXPLORER("손훑기")
	PRINTFORML %CALLNAME:TARGET%의 교묘한 손놀림에 가버리고 말았다！
ELSEIF PALAM_EXPLORER("풋잡")
	PRINTFORML %CALLNAME:TARGET%의 풋잡으로 가버리고 말았다！
ELSEIF PALAM_EXPLORER("안면기승") || PALAM_EXPLORER("식스나인")
	PRINTFORML %CALLNAME:TARGET%에게 격렬한 안면기승을 받아 가버리고 말았다！
ELSEIF PALAM_EXPLORER("파이즈리")
	PRINTFORML %CALLNAME:TARGET%의 가슴의 마력에 굴복해 버렸다！
ELSE
	PRINTFORML %CALLNAME:TARGET%에게 가버리고 말았다！
ENDIF

RESETCOLOR

EXP:경험치 += MAX(2*(ABL:PLAYER:ＬＶ - ABL:ＬＶ), 0) + 3
EXP:절정시킨횟수 += 1
IF TALENT:PLAYER:여자
	EXP:PLAYER:절정경험 += 1
ELSEIF TALENT:PLAYER:후타나리
	EXP:PLAYER:절정경험 += 1
	EXP:PLAYER:사정경험 += 1
	EXP:정액경험 += 2
ELSE
	EXP:PLAYER:사정경험 += 1
	EXP:정액경험 += 2
ENDIF

;決着台詞
TRYCALL KOJO_MESSAGE_SEXBATTLE_B, NO:TARGET

IF BASE:PLAYER:스톡 > 0
	BASE:PLAYER:정력 = MAXBASE:PLAYER:정력
	BASE:PLAYER:스톡 -= 1
	PRINTFORML 그러나, 기력을 쥐어짜 다시 일어났다! 
ENDIF

WAIT

@TEXT_WIN_EXPLORER
PRINTFORM %조사처리(CALLNAME:PLAYER,"는")% %CALLNAME:TARGET%

R = RAND:3

IF PALAM_EXPLORER("両穴征옷")
	PRINTFORML 의 양쪽 구멍을 범해서 만족시켰다. 
ELSEIF PALAM_EXPLORER("Ｖ인서트")
	PRINTFORMW %조사만처리(CALLNAME:TARGET,"를")% 격렬하게 범해서 만족시켰다. 
ELSEIF PALAM_EXPLORER("Ａ인서트")
	PRINTFORML 의 애널을 격렬하게 범해서 만족시켰다. 
ELSEIF PALAM_EXPLORER("에이스오브스페이드")
	PRINTFORML 의 성기에 자신의 성기를 문질러서 만족시켰다. 
ELSEIF PALAM_EXPLORER("ヴァッジ")
	IF R == 2
		PRINTFORML 의 성기를 혀로 애무해서 만족시켰다. 
	ELSEIF R == 1
		PRINTFORML 의 성기를 손가락으로 희롱하며, 교묘하게 애무해서 만족시켰다. 
	ELSE
		PRINTFORML 의 성기를 손가락으로 격렬하게 애무해서 만족시켰다. 
	ENDIF
ELSEIF PALAM_EXPLORER("애널")
	IF R == 2
		PRINTFORML 의 애널을 혀로 애무해서 만족시켰다.
	ELSEIF R == 1
		PRINTFORML 의 애널을 손가락으로 희롱하며, 교묘하게 애무해서 만족시켰다
	ELSE
		PRINTFORML 의 애널을 손가락으로 격렬하게 애무해서 만족시켰다. 
	ENDIF
ELSEIF PALAM_EXPLORER("바스트")
	IF R == 2
		PRINTFORML 의 유두를 혀로 애무해서 만족시켰다. 
	ELSEIF R == 1
		PRINTFORML 의 가슴을 격렬하게 주물러서 만족시켰다. 
	ELSE
		PRINTFORML 의 가슴을 감싸듯이 문질러서 만족시켰다. 
	ENDIF
ELSEIF PALAM_EXPLORER("키스")
	IF R == 2
		PRINTFORML 에게 정열적인 키스를 해서 만족시켰다. 
	ELSEIF R == 1
		PRINTFORML 에게 진한 키스를 해서 만족시켰다. 
	ELSE
		PRINTFORML 에게 뜨거운 키스를 해서 만족시켰다. 
	ENDIF
ELSE
	PRINTFORMW %조사만처리(CALLNAME:TARGET,"를")% 격렬하게 범해서 만족시켰다. 
ENDIF

EXP:절정경험 += 1
TRYCALL KOJO_MESSAGE_SEXBATTLE_B, NO:TARGET

;後が控えてる？
IF TARGET != PALAM_EXPLORER("一人目")
	TARGET -= 1
	;무드以外の탈의, 인서트, 行動플래그リセット
	CALL SET_PALAM_EXPLORER, "전투플래그리셋"
ENDIF

@SELECTCOM_SEXBATTLE_EXPLORER
CALL SET_PALAM_EXPLORER, "行動", 0
SELECTCASE PALAM_EXPLORER("무드")
;무드LV0
CASE 0
	CALL SET_PALAM_EXPLORER, "텐더키스"
;무드LV1
CASE IS <= 4
	IF RAND:(PALAM_EXPLORER("무드") + 1) == 0
		CALL SET_PALAM_EXPLORER, "텐더키스"
	ELSEIF TALENT:PLAYER:달콤한말 && RAND:(PALAM_EXPLORER("무드") + 3) == 0
		CALL SET_PALAM_EXPLORER, "달콤한말"
	ELSEIF PALAM_EXPLORER("탈의") == 0 && RAND:PALAM_EXPLORER("무드") > RAND:4
		CALL SET_PALAM_EXPLORER, "탈의", 1
	ELSEIF RAND:4 == 0
		CALL SET_PALAM_EXPLORER, "애널"
	ELSEIF RAND:3 == 0
		CALL SET_PALAM_EXPLORER, "ヴァッジ"
	ELSEIF RAND:2
		CALL SET_PALAM_EXPLORER, "바스트"
	ELSE
		CALL SET_PALAM_EXPLORER, "키스"
	ENDIF
;무드LV2이상
CASEELSE
	IF PALAM_EXPLORER("무드") < 10 && RAND:(PALAM_EXPLORER("무드") + 1) == 0
		CALL SET_PALAM_EXPLORER, "텐더키스"
	ELSEIF PALAM_EXPLORER("무드") < 10 && TALENT:PLAYER:달콤한말 && RAND:PALAM_EXPLORER("무드") <= 1
		CALL SET_PALAM_EXPLORER, "달콤한말"
	ELSEIF PALAM_EXPLORER("Ａ인서트") && RAND:PALAM_EXPLORER("무드")
		SIF RAND:4 == 0
			CALL SET_PALAM_EXPLORER, "Ｖ인서트"
	ELSEIF PALAM_EXPLORER("Ｖ인서트") && RAND:PALAM_EXPLORER("무드")
		SIF RAND:4 == 0 && (TALENT:Ａ민감 || TALENT:PLAYER:새드 || COND("♀에약함", PLAYER)) && RAND:(1 + EXP:PLAYER:Ａ삽입경험) > RAND:(1 + EXP:PLAYER:Ｖ삽입경험)
			CALL SET_PALAM_EXPLORER, "Ａ인서트"
	;인서트等
	ELSEIF PALAM_EXPLORER("탈의") && PALAM_EXPLORER("체위") == 0 && RAND:PALAM_EXPLORER("무드") >= 2 && TALENT:요정 == 0
		;女なら에이스오브스페이드. 후타나리は상대が바이ならたまにやる
		IF TALENT:PLAYER:여자 || (TALENT:PLAYER:후타나리 && TALENT:바이 && RAND:4 == 0)
			CALL SET_PALAM_EXPLORER, "에이스오브스페이드"
		;애널섹스
		ELSEIF (TALENT:Ａ민감 || TALENT:PLAYER:새드 || COND("♀에약함", PLAYER)) && RAND:(1 + EXP:PLAYER:Ａ삽입경험) > RAND:(1 + EXP:PLAYER:Ｖ삽입경험)
			CALL SET_PALAM_EXPLORER, "Ａ인서트"
		ELSEIF (TALENT:PLAYER:동정 && CONFIG("脱동정필터") ) || TALENT:처녀
			IF RAND:4 == 0
				CALL SET_PALAM_EXPLORER, "애널"
			ELSEIF RAND:3 == 0
				CALL SET_PALAM_EXPLORER, "ヴァッジ"
			ELSEIF RAND:2
				CALL SET_PALAM_EXPLORER, "바스트"
			ELSE
				CALL SET_PALAM_EXPLORER, "키스"
			ENDIF
		ELSE
			CALL SET_PALAM_EXPLORER, "Ｖ인서트"
		ENDIF
	ELSEIF PALAM_EXPLORER("탈의") == 0 && RAND:PALAM_EXPLORER("무드") >= 1
		CALL SET_PALAM_EXPLORER, "탈의", 1
	ELSEIF RAND:4 == 0
		CALL SET_PALAM_EXPLORER, "애널"
	ELSEIF RAND:3 == 0
		CALL SET_PALAM_EXPLORER, "ヴァッジ"
	ELSEIF RAND:2
		CALL SET_PALAM_EXPLORER, "바스트"
	ELSE
		CALL SET_PALAM_EXPLORER, "키스"
	ENDIF
ENDSELECT

VARSET LOCAL
IF PALAM_EXPLORER("텐더키스")
	BASE:정력 -= 1
	CALL SET_PALAM_EXPLORER, "무드", 2
	EXP:키스경험 += 1
	EXP:PLAYER:키스경험 += RAND:2
ELSEIF PALAM_EXPLORER("키스")
	CALL ATTACK_SEXBATTLE_EXPLORER
	BASE:정력 -= ABL:PLAYER:혀놀림
	LOCAL = TALENT:Ｍ민감
	EXP:키스경험 += 1
	EXP:PLAYER:키스경험 += 1
ELSEIF PALAM_EXPLORER("바스트")
	CALL ATTACK_SEXBATTLE_EXPLORER
	BASE:정력 -= (ABL:PLAYER:혀놀림 + ABL:PLAYER:손가락놀림)/2
	LOCAL = TALENT:Ｂ민감
	EXP:PLAYER:수음경험 += 1
ELSEIF PALAM_EXPLORER("애널")
	CALL ATTACK_SEXBATTLE_EXPLORER
	BASE:정력 -= (ABL:PLAYER:혀놀림 + ABL:PLAYER:손가락놀림)/2
	LOCAL = TALENT:Ａ민감
	EXP:Ａ경험 += 1
	EXP:PLAYER:Ａ자극경험 += 1
ELSEIF PALAM_EXPLORER("애널")
	CALL ATTACK_SEXBATTLE_EXPLORER
	BASE:정력 -= (ABL:PLAYER:혀놀림 + ABL:PLAYER:손가락놀림)/2
	LOCAL = TALENT:Ｃ민감 + TALENT:Ｖ민감
	IF RAND:2 == 0
		EXP:PLAYER:커닐링구스경험 += 1
	ELSE
		EXP:PLAYER:수음경험 += 1
	ENDIF
ELSEIF PALAM_EXPLORER("Ｖ인서트")
	CALL ATTACK_SEXBATTLE_EXPLORER
	BASE:정력 -= ABL:PLAYER:허리놀림 + 1
	LOCAL = TALENT:Ｖ민감

	IF TALENT:PLAYER:동정
		SETCOLOR DEF_COLOR("노랑")
		PRINTFORML %조사처리(CALLNAME:PLAYER,"는")% 동정을 잃었다! 
		RESETCOLOR
		TALENT:PLAYER:동정 = 0
		TALENT:첫사람 = 1
	ENDIF
	IF PENIS(PLAYER)
		EXP:PLAYER:Ｖ삽입경험 += 1
		EXP:Ｖ성교경험 += 1
	ENDIF
	EXP:PLAYER:허리사용경험 += 1
	TALENT:처녀 = 0
	EXP:Ｖ경험 += 2
ELSEIF PALAM_EXPLORER("Ａ인서트")
	CALL ATTACK_SEXBATTLE_EXPLORER
	BASE:정력 -= ABL:PLAYER:허리놀림
	IF TALENT:Ａ민감
		BASE:정력 -= 2
		CALL SET_PALAM_EXPLORER, "무드", RAND:2
	ELSE
		CALL SET_PALAM_EXPLORER, "무드", -2
	ENDIF
	IF PENIS(PLAYER)
		EXP:PLAYER:Ａ삽입경험 += 1
		EXP:Ａ성교경험 += 1
	ENDIF
	EXP:PLAYER:허리사용경험 += 1
	TALENT:Ａ처녀 = 0
	EXP:Ａ경험 += 2
;에이스오브스페이드
ELSEIF PALAM_EXPLORER("에이스오브스페이드")
	CALL ATTACK_SEXBATTLE_EXPLORER
	BASE:정력 -= ABL:PLAYER:허리놀림 + 1
	LOCAL = TALENT:Ｃ민감
	EXP:PLAYER:허리사용경험 += 1
;달콤한말
ELSEIF PALAM_EXPLORER("달콤한말")
	CALL SET_PALAM_EXPLORER, "무드", 3
ENDIF

;성감대突き
IF LOCAL
	BASE:정력 -= 1 + (1 + ABL:PLAYER:기교)/2
	CALL SET_PALAM_EXPLORER, "무드", 1
ENDIF

;イきそう
SIF BASE:정력 < MAXBASE:정력/3 && PALAM_EXPLORER("무드") < 5
	CALL SET_PALAM_EXPLORER, "무드", 1

;レズ, BL経験
IF TALENT:남자 == 0 && TALENT:PLAYER:남자 == 0
	EXP:PLAYER:레즈경험 += 2
	EXP:레즈경험 += 2
ELSEIF TALENT:남자 && TALENT:PLAYER:남자
	EXP:PLAYER:ＢＬ경험 += 2
	EXP:ＢＬ경험 += 2
ENDIF


@ATTACK_SEXBATTLE_EXPLORER
LOCAL = PALAM_EXPLORER("탐색者공격력", PLAYER)
;아르카나の罠で不器用になっている
SIF PALAM_EXPLORER("クラムジ")
	LOCAL -= 1 + RAND:3
;LVの差
SIF ABL:PLAYER:ＬＶ - ABL:ＬＶ
	LOCAL += 1 + (ABL:PLAYER:ＬＶ - ABL:ＬＶ) / 3
;탈의済み
SIF PALAM_EXPLORER("탈의")
	LOCAL += 1

;MASTER専用보정
IF PLAYER == MASTER
	;조수
	IF ASSI
		LOCAL += PALAM_EXPLORER("조수공격력", ASSI) + PALAM_EXPLORER("아르카나補助", ASSI)
		SIF ABL:ASSI:ＬＶ > ABL:ＬＶ
			LOCAL += 1
	ENDIF
ELSE
	;상위몽마
	IF TALENT:PLAYER:상위몽마
		LOCAL += TALENT:PLAYER:상위몽마
		SIF TALENT:상위몽마 == 0
			LOCAL += 1
	ENDIF
ENDIF

;하피三姉妹
IF NO:TARGET == 38 && PALAM_EXPLORER("敵キャラ数") >= 2
	IF NO:PALAM_EXPLORER("二人目") == 39 && NO:PALAM_EXPLORER("三人目") == 40
		LOCAL = LOCAL/4 + 1
	ELSEIF PALAM_EXPLORER("敵キャラ数") >= 2
		LOCAL = LOCAL/2 + 1
	ENDIF
ENDIF

SIF LOCAL <= 0
	BASE:정력 = MAX(RAND:2, 0)
BASE:정력 -= LOCAL

@COUNTER_SEXBATTLE_EXPLORER
;달콤한말の時には待ってくれるかも
SIF PALAM_EXPLORER("달콤한말") && RAND:2 == 0
	RETURN 0

IF PALAM_EXPLORER("Ｖ인서트")
	TALENT:처녀 = 0
	EXP:Ｖ경험 += 2
	EXP:허리사용경험 += 1
	IF PENIS(PLAYER)
		EXP:PLAYER:Ｖ삽입경험 += 1
		EXP:Ｖ성교경험 += 1
	ENDIF
ELSEIF PALAM_EXPLORER("Ａ인서트")
	TALENT:Ａ처녀 = 0
	EXP:Ａ경험 += 2
	EXP:허리사용경험 += 1
	IF PENIS(PLAYER)
		EXP:PLAYER:Ａ삽입경험 += 1
		EXP:Ａ성교경험 += 1
	ENDIF
ELSEIF PALAM_EXPLORER("에이스오브스페이드")
	EXP:허리사용경험 += 1
;혀놀림
ELSEIF ABL:혀놀림 >= MAX(ABL:손가락놀림, ABL:발놀림, ABL:허리놀림, ABL:마유, 1) && RAND:3
	IF RAND:2 == 0 || TALENT:PLAYER:여자
		CALL SET_PALAM_EXPLORER, "키스"
		EXP:키스경험 += 1
	ELSE
		IF PALAM_EXPLORER("ヴァッジ")
			CALL SET_PALAM_EXPLORER, "식스나인"
		ELSE
			CALL SET_PALAM_EXPLORER, "펠라치오"
		ENDIF
		IF PENIS(PLAYER)
			EXP:펠라경험 += 1
		ELSE
			EXP:커닐링구스경험 += 1
		ENDIF
	ENDIF
;손가락놀림
ELSEIF ABL:손가락놀림 >= MAX(ABL:혀놀림, ABL:발놀림, ABL:허리놀림, ABL:마유, 1) && RAND:3
	IF TALENT:새드 && RAND:2 == 0
		CALL SET_PALAM_EXPLORER, "애널자극"
		EXP:Ａ자극경험 += 1
	ELSE
		CALL SET_PALAM_EXPLORER, "손훑기"
		EXP:수음경험 += 1
	ENDIF
;발놀림
ELSEIF COND("다리が無い") == 0 && ABL:발놀림 >= MAX(ABL:혀놀림, ABL:손가락놀림, ABL:허리놀림, ABL:마유, 1) && RAND:3
	CALL SET_PALAM_EXPLORER, "풋잡"
	EXP:풋잡경험 += 1
;허리놀림
ELSEIF ABL:허리놀림 >= MAX(ABL:혀놀림, ABL:손가락놀림, ABL:발놀림, ABL:마유, 1) && RAND:3
	CALL SET_PALAM_EXPLORER, "안면기승"
	EXP:허리사용경험 += 1
;마유
ELSEIF ABL:마유 >= MAX(ABL:혀놀림, ABL:손가락놀림, ABL:발놀림, ABL:허리놀림, 1) && RAND:3
	CALL SET_PALAM_EXPLORER, "파이즈리"
	EXP:파이즈리경험 += 1
ELSEIF RAND:7 == 0
	CALL SET_PALAM_EXPLORER, "풋잡"
ELSEIF RAND:6 == 0
	CALL SET_PALAM_EXPLORER, "펠라치오"
ELSEIF RAND:5 == 0
	CALL SET_PALAM_EXPLORER, "손훑기"
ELSEIF RAND:4 == 0
	CALL SET_PALAM_EXPLORER, "안면기승"
ELSEIF RAND:3 == 0
	CALL SET_PALAM_EXPLORER, "애널자극"
ELSEIF RAND:2
	CALL SET_PALAM_EXPLORER, "파이즈리"
ELSE
	CALL SET_PALAM_EXPLORER, "키스"
ENDIF

LOCAL = PALAM_EXPLORER("공격력")

SIF RAND:(PALAM_EXPLORER("敵の強さ") + 1)
	LOCAL += 1 + RAND:(PALAM_EXPLORER("敵の強さ") + 1)/3

SELECTCASE PALAM_EXPLORER("敵キャラ数")
CASE IS >= 3
	LOCAL += 3
CASE 2
	LOCAL += 1
ENDSELECT

LOCAL = DIVIDE(LOCAL, 100 + TALENT:PLAYER:정신력강화)

SIF PALAM_EXPLORER("센시브")
	LOCAL += 2
;行動
IF PALAM_EXPLORER("키스") || PALAM_EXPLORER("펠라치오")
	LOCAL += RAND:(ABL:혀놀림 + 1) + MIN(COND("입에약함", PLAYER) + COND("키스에약함", PLAYER), 1)
ELSEIF PALAM_EXPLORER("식스나인")
	LOCAL += RAND:(ABL:혀놀림 + 1) + MIN(COND("입에약함", PLAYER) + COND("키스에약함", PLAYER), 1)
	LOCAL += RAND:(ABL:허리놀림 + 1) + MIN(COND("♀에약함", PLAYER), 1)
ELSEIF PALAM_EXPLORER("애널자극") || PALAM_EXPLORER("손훑기")
	LOCAL += RAND:(ABL:손가락놀림 + 1) + MIN(COND("손에약함", PLAYER), 1)
ELSEIF PALAM_EXPLORER("풋잡")
	LOCAL += RAND:(ABL:발놀림 + 1) + MIN(COND("다리에약함", PLAYER), 1)
ELSEIF PALAM_EXPLORER("안면기승") || PALAM_EXPLORER("Ｖ인서트") || PALAM_EXPLORER("에이스오브스페이드")
	LOCAL += RAND:(ABL:허리놀림 + 1) + MIN(COND("♀에약함", PLAYER), 1)
ELSEIF PALAM_EXPLORER("Ａ인서트")
	LOCAL += RAND:(ABL:허리놀림 + 1) + MIN(COND("♀에약함", PLAYER), 1)
ELSEIF PALAM_EXPLORER("파이즈리")
	LOCAL += RAND:(ABL:마유 + 1) + MIN(COND("가슴에약함", PLAYER), 1)
ENDIF
;하피三姉妹
IF NO:TARGET == 38 && PALAM_EXPLORER("敵キャラ数") >= 2
	IF NO:PALAM_EXPLORER("二人目") == 39 && NO:PALAM_EXPLORER("三人目") == 40
		LOCAL += 10
	ELSEIF PALAM_EXPLORER("敵キャラ数") >= 2
		LOCAL += 5
	ENDIF
ENDIF

;조수がいる
IF PLAYER == MASTER && ASSI
	SIF PALAM_EXPLORER("아르카나補助", ASSI) >= 2
		LOCAL -= 1
	SIF ABL:ASSI:기교 >= ABL:기교
		LOCAL -= 1
	SIF ABL:ASSI:ＬＶ > ABL:ＬＶ
		LOCAL -= 1
ENDIF
IF LOCAL < 1
	IF RAND:(ABL:기교 + 2)
		LOCAL = 1
	ELSE
		LOCAL = 0
	ENDIF
ENDIF

BASE:PLAYER:정력 -= LOCAL
